# Voice Streaming - Component Diagrams

## 1. System Context Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           VOICE STREAMING SYSTEM                             │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         ┌─────────────────────────┐                │    │
│  │  ┌─────────────┐        │                         │               │    │
│  │  │  Agent A   │        │    SIGNALING SERVER      │               │    │
│  │  │  Client    │◄──────►│  (WebSocket + REST)      │               │    │
│  │  └──────┬──────┘        │                         │               │    │
│  │         │               └────────────┬────────────┘               │    │
│  │         │                          │                              │    │
│  │    [P2P Audio - WebRTC]             │                             │    │
│  │         │                          │                              │    │
│  │         │               ┌──────────┴──────────┐                   │    │
│  │         │               │                     │                   │    │
│  │  ┌──────┴──────┐        │   DATA LAYER        │                   │    │
│  │  │  Agent B   │        │   (PostgreSQL)       │                   │    │
│  │  │  Client    │◄──────►│                     │                   │    │
│  │  └─────────────┘        │                     │                   │    │
│  │                         └─────────────────────┘                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  External:                                                                  │
│  ┌─────────────┐   ┌─────────────┐                                        │
│  │  TURN Svr   │   │  STUN Svr   │                                        │
│  │  (Relay)    │   │  (NAT Fix)  │                                        │
│  └─────────────┘   └─────────────┘                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. Backend Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           VOICE SERVER BACKEND                              │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         ENTRY LAYER                                   │  │
│  │  ┌───────────────┐  ┌───────────────┐  ┌─────────────────────────┐  │  │
│  │  │ Load Balancer │  │   SSL/TLS     │  │   Rate Limiter          │  │  │
│  │  │  (Nginx)      │  │ Termination   │  │   Middleware            │  │  │
│  │  └───────────────┘  └───────────────┘  └─────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      API GATEWAY                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │              Request Router & Dispatcher                        │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│              ┌─────────────────────┼─────────────────────┐                 │
│              │                     │                     │                 │
│              ▼                     ▼                     ▼                 │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐│  │
│  │   REST API LAYER    │ │  WEBSOCKET LAYER    │ │   AUTH LAYER        ││  │
│  │                     │ │                     │ │                     ││  │
│  │  ┌─────────────────┐ │ ┌─────────────────┐ │ │ ┌─────────────────┐ ││  │
│  │  │ Room Handlers   │ │ │ Connection Mgr  │ │ │ │ JWT Validator   │ ││  │
│  │  │ - Create        │ │ │ - Socket life   │ │ │ │ - Token decode  │ ││  │
│  │  │ - Get/List      │ │ │ - Heartbeat     │ │ │ │ - Expiry check  │ ││  │
│  │  │ - Update        │ │ │ - State track   │ │ │ └─────────────────┘ ││  │
│  │  │ - Delete        │ │ └─────────────────┘ │ │ ┌─────────────────┐ ││  │
│  │  └─────────────────┘ │ ┌─────────────────┐ │ │ │ API Key Handler │ ││  │
│  │  ┌─────────────────┐ │ │ Room Manager     │ │ │ │ - Key validation│ ││  │
│  │  │ Participant     │ │ │ - Room CRUD      │ │ │ └─────────────────┘ ││  │
│  │  │ Handlers        │ │ │ - Participant mgmt│ │ └─────────────────────┘│  │
│  │  │ - Join         │ │ │ - State machine  │ │                       │  │
│  │  │ - Leave        │ │ └─────────────────┘ │ │                       │  │
│  │  │ - List         │ │ ┌─────────────────┐ │ │                       │  │
│  │  └─────────────────┘ │ │ Signaling Handler││ │                       │  │
│  │  ┌─────────────────┐ │ │ - Offer/Answer  │ │ │                       │  │
│  │  │ Session Handlers │ │ │ - ICE exchange  │ │ │                       │  │
│  │  │ - Create        │ │ │ - Event broadcast│ │ │                       │  │
│  │  │ - Get/List      │ │ └─────────────────┘ │ │                       │  │
│  │  │ - End           │ │                     │ │                       │  │
│  │  └─────────────────┘ │                     │ │                       │  │
│  └─────────────────────┴─────────────────────┴───────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      DATA ACCESS LAYER                                │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │              Database Connection Pool                           │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │       │          │          │          │          │                     │  │
│  │       ▼          ▼          ▼          ▼          ▼                     │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐               │  │
│  │  │  Room  │ │Participant│ │Session │ │   ICE  │ │Analytics│            │  │
│  │  │ Model │ │ Model   │ │ Model  │ │ Model │ │  Model │               │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. WebRTC Signaling Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          WEBRTC SIGNALING FLOW                              │
│                                                                             │
│  Agent A                         Signaling Server                        Agent B
│    │                                  │                                      │
│    │  1. WebSocket Connect            │                                      │
│    │─────────────────────────────────▶│                                      │
│    │                                  │  2. WebSocket Connect               │
│    │                                  │◀─────────────────────────────────────│
│    │                                  │                                      │
│    │  3. room:join                    │                                      │
│    │─────────────────────────────────▶│                                      │
│    │  4. room:participant-joined      │                                      │
│    │◀─────────────────────────────────│                                      │
│    │                                  │  5. room:join                        │
│    │                                  │◀─────────────────────────────────────│
│    │                                  │                                      │
│    │◀─────────────────────────────────│  6. room:participant-joined         │
│    │  7. room:participant-joined      │                                      │
│    │     (with Agent B info)          │                                      │
│    │                                  │                                      │
│    │  ════════════════════════════════╧═══════════════════════════════      │
│    │  ║           WEBRTC NEGOTIATION PHASE                          ║      │
│    │  ╠══════════════════════════════════════════════════════════════════╣  │
│    │  │                                                                │  │
│    │  │  8. createOffer() ─────► RTCSessionDescription ──────────────┤  │
│    │  │                         (SDP Offer)                            │  │
│    │  │                                                               │  │
│    │  │  9. webrtc:offer ─────────────────────────────────────────────▶│  │
│    │  │ 10. on(webrtc:offer)                                         │  │
│    │  │                                                                │  │
│    │  │ 11. createAnswer() ─────► RTCSessionDescription ─────────────│  │
│    │  │                        (SDP Answer)                            │  │
│    │  │                                                                │  │
│    │  │ 12. webrtc:answer ◀────────────────────────────────────────────│  │
│    │  │ 13. on(webrtc:answer)                                        │  │
│    │  │                                                                │  │
│    │  │ 14. addIceCandidate()                                         │  │
│    │  │      ICE candidates generated                                 │  │
│    │  │                                                                │  │
│    │  │ 15. webrtc:ice-candidate ──────────────────────────────────▶│  │
│    │  │ 16. on(webrtc:ice-candidate)                                 │  │
│    │  │                                                                │  │
│    │  │ 17. webrtc:ice-candidate ◀────────────────────────────────────│  │
│    │  │ 18. on(webrtc:ice-candidate)                                 │  │
│    │  │                                                                │  │
│    │  ╠══════════════════════════════════════════════════════════════════╣  │
│    │  ╚══════════════════════════════════════════════════════════════════╝  │
│    │  ════════════════════════════════════════════════════════════════      │
│    │                                  │                                      │
│    │                                  │                                      │
│    │ 19. ICE Connection Established  │                                      │
│    │◀═════════════════════════════════╪═════════════════════════════════▶   │
│    │                                  │                                      │
│    │ 20. voice:stream-started        │                                      │
│    │◀─────────────────────────────────│                                      │
│    │                                  │ 21. voice:stream-started            │
│    │                                  │◀─────────────────────────────────────│
│    │                                  │                                      │
│    │ 22. ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓   │                                      │
│    │     ▓ P2P AUDIO STREAM ▓◄────────┼─────────────►▓ P2P AUDIO STREAM ▓   │
│    │  23. ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓   │                                      │
│    │                                  │                                      │
│    │ 24. room:leave                   │                                      │
│    │─────────────────────────────────▶│                                      │
│    │                                  │ 25. room:participant-left           │
│    │                                  │◀─────────────────────────────────────│
│    │                                  │                                      │
│    │                                  │ 26. room:leave                        │
│    │                                  │◀─────────────────────────────────────│
│    │                                  │                                      │
│    └──────────────────────────────────┴──────────────────────────────────────┘
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. Frontend Component Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FRONTEND APPLICATION                              │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         <App />                                       │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │              <VoiceRoomProvider />                             │ │  │
│  │  │  ┌───────────────────────────────────────────────────────────┐ │ │  │
│  │  │  │                    State Store                           │ │ │  │
│  │  │  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐   │ │ │  │
│  │  │  │  │ Room State    │ │ Participant   │ │ Connection    │   │ │ │  │
│  │  │  │  │ - id          │ │ List          │ │ State         │   │ │ │  │
│  │  │  │  │ - name        │ │ - agentId     │ │ - connected   │   │ │ │  │
│  │  │  │  │ - status      │ │ - status      │ │ - reconnecting│   │ │ │  │
│  │  │  │  │ - settings    │ │ - metadata    │ │ - error       │   │ │ │  │
│  │  │  │  └───────────────┘ └───────────────┘ └───────────────┘   │ │ │  │
│  │  │  │  ┌───────────────┐ ┌───────────────┐                     │ │ │  │
│  │  │  │  │ Audio State   │ │ WebRTC State  │                     │ │ │  │
│  │  │  │  │ - isMuted     │ │ - peerConn    │                     │ │ │  │
│  │  │  │  │ - isDeafened  │ │ - localStream │                     │ │ │  │
│  │  │  │  │ - volume      │ │ - remoteStreams                   │ │ │  │
│  │  │  │  └───────────────┘ └───────────────┘                     │ │ │  │
│  │  │  └───────────────────────────────────────────────────────────┘ │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌───────────────────────────────────────────────────────────┐ │ │  │
│  │  │  │              Custom Hooks Layer                            │ │ │  │
│  │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │ │ │  │
│  │  │  │  │useVoiceRoom │ │ useWebRTC  │ │  useAudioContext   │  │ │ │  │
│  │  │  │  │ - joinRoom  │ │ - createPC  │ │  - context         │  │ │ │  │
│  │  │  │  │ - leaveRoom │ │ - createOffer │ │ - analyser       │  │ │ │  │
│  │  │  │  │ - muteLocal │ │ - createAns │ │ - gainNode       │  │ │ │  │
│  │  │  │  └─────────────┘ └─────────────┘ └─────────────────────┘  │ │ │  │
│  │  │  └───────────────────────────────────────────────────────────┘ │ │  │
│  │  └─────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    <Layout />                                    │ │  │
│  │  │  ┌─────────────────────────┐  ┌───────────────────────────────┐ │ │  │
│  │  │  │       <Header />        │  │        <MainContent />       │ │ │  │
│  │  │  │  ┌───────────────────┐  │  │                               │ │ │  │
│  │  │  │  │ <Logo />          │  │  │  ┌─────────────────────────┐ │ │ │  │
│  │  │  │  │ <RoomTitle />     │  │  │  │   <RoomView />         │ │ │ │  │
│  │  │  │  │ <StatusIndicator/>│  │  │  │  ┌───────────────────┐ │ │ │ │  │
│  │  │  │  └───────────────────┘  │  │  │  │ <ConnectionPanel/>│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ ┌───────────────┐│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │<ParticipantList>│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ ┌───────────┐│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │<ParticipantCard│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ ┌─────────┐│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ │<Avatar/>││ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ │ │<Name/> ││ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ │ │<Status/>││ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ │ └─────────┘│ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ │ └───────────┘ │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │ └───────────────┘ │ │ │  │
│  │  │  │                        │  │  │  │ │ └───────────────────┘ │ │  │
│  │  │  │                        │  │  │  │ ┌───────────────────┐ │ │  │
│  │  │  │                        │  │  │  │ │ <AudioControls /> │ │ │  │
│  │  │  │                        │  │  │  │ │ ┌───────────────┐ │ │ │  │
│  │  │  │                        │  │  │  │ │ │<MuteButton /> │ │ │ │  │
│  │  │  │                        │  │  │  │ │ │<DeafenButton/>│ │ │ │  │
│  │  │  │                        │  │  │  │ │ │<EndCallButton>│ │ │ │  │
│  │  │  │                        │  │  │  │ │ │<SettingsBtn/> │ │ │ │  │
│  │  │  │                        │  │  │  │ │ └───────────────┘ │ │  │
│  │  │  │                        │  │  │  │ └───────────────────┘ │  │
│  │  │  │                        │  │  │  └───────────────────────┘  │
│  │  │  │                        │  │  └─────────────────────────────┘  │
│  │  │  │                        │  │                                  │
│  │  │  │                        │  │  [No Active Room]                │
│  │  │  │                        │  │  ┌─────────────────────────┐     │
│  │  │  │                        │  │  │   <RoomList />          │     │
│  │  │  │                        │  │  │  ┌───────────────────┐ │     │
│  │  │  │                        │  │  │  │ <RoomCard />      │ │     │
│  │  │  │                        │  │  │  │ - name            │ │     │
│  │  │  │                        │  │  │  │ - participants    │ │     │
│  │  │  │                        │  │  │  │ - status          │ │     │
│  │  │  │                        │  │  │  │ └───────────────────┘ │     │
│  │  │  │                        │  │  │  │ <CreateRoomButton />  │     │
│  │  │  │                        │  │  │  └─────────────────────────┘     │
│  │  │  │                        │  │  └───────────────────────────────   │
│  │  │  │                        │  │                                   │
│  │  │  │                        │  └─────────────────────────────────────┘  │
│  │  │  │                        │                                          │
│  │  │  │                        └──────────────────────────────────────────┘   │
│  │  │  └─────────────────────────────────────────────────────────────────────┘   │
│  │  └─────────────────────────────────────────────────────────────────────────────┘   │
│  │                                                                                   │
│  └───────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

## 5. Data Flow Diagram - Voice Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VOICE DATA PIPELINE                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Agent A (Sender)                              │   │
│  │                                                                       │   │
│  │  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐         │   │
│  │  │   Mic   │────▶│  Audio  │────▶│  Media  │────▶│ RTCPeer │         │   │
│  │  │ Input   │     │ Encoder │     │ Stream  │     │ Conn    │         │   │
│  │  │         │     │ (Opus)  │     │ Track   │     │         │         │   │
│  │  └─────────┘     └─────────┘     └─────────┘     └────┬────┘         │   │
│  │        │           │              │                  │              │   │
│  │        ▼           ▼              ▼                  ▼              │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────┐  ┌─────────────────┐      │   │
│  │  │ Sample  │  │ 50ms    │  │ 48kHz, mono │  │ ICE Candidate   │      │   │
│  │  │ Rate:   │  │ frames  │  │ 16-bit PCM  │  │ Generation      │      │   │
│  │  │ 48kHz   │  └─────────┘  └─────────────┘  └────────┬────────┘      │   │
│  │  └─────────┘                                          │               │   │
│  │                                                       │               │   │
│  │                                    ┌─────────────────▼───────────┐   │   │
│  │                                    │    SRTP Encapsulation        │   │   │
│  │                                    │  ┌─────────────────────────┐ │   │   │
│  │                                    │  │ RTP Header + Payloads  │ │   │   │
│  │                                    │  │ Encrypted with AES-CTR  │ │   │   │
│  │                                    │  └─────────────────────────┘ │   │   │
│  │                                    └──────────────────┬──────────┘   │   │
│  │                                                       │              │   │
│  │                                    ┌──────────────────┴──────────┐   │   │
│  │                                    │      Network Transport      │   │   │
│  │                                    │     (UDP + NAT Traversal)  │   │   │
│  │                                    └──────────────────┬──────────┘   │   │
│  │                                                       │              │   │
│  └───────────────────────────────────────────────────────┼──────────────┘   │
│                                                           │                  │
│                                                           │                  │
│  ┌───────────────────────────────────────────────────────┼──────────────┐   │
│  │                                                       │              │   │
│  │                                    ┌──────────────────┴──────────┐   │   │
│  │                                    │      Network Transport      │   │   │
│  │                                    │     (UDP + NAT Traversal)  │   │   │
│  │                                    └──────────────────┬──────────┘   │   │
│  │                                                       │              │   │
│  │                                    ┌─────────────────▼───────────┐   │   │
│  │                                    │    SRTP Decapsulation        │   │   │
│  │                                    │  ┌─────────────────────────┐ │   │   │
│  │                                    │  │ RTP Header + Payloads  │ │   │   │
│  │                                    │  │ Decrypted with AES-CTR  │ │   │   │
│  │                                    │  └─────────────────────────┘ │   │   │
│  │                                    └──────────────────┬──────────┘   │   │
│  │                                                       │              │   │
│  │                                    ┌─────────────────▼───────────┐   │   │
│  │                                    │    RTCPeerConnection        │   │   │
│  │                                    │  ┌─────────────────────────┐ │   │   │
│  │                                    │  │ Remote Media Stream     │ │   │   │
│  │                                    │  │ Track Extraction        │ │   │   │
│  │                                    │  └─────────────────────────┘ │   │   │
│  │                                    └──────────────────┬──────────┘   │   │
│  │                                                       │              │   │
│  │  ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐         │   │
│  │  │ Speaker │◀────│  Audio  │◀────│  Audio  │◀────│Remote   │         │   │
│  │  │ Output  │     │Decoder  │     │ Buffer │     │ Stream  │         │   │
│  │  │         │     │ (Opus)  │     │        │     │ Track   │         │   │
│  │  └─────────┘     └─────────┘     └─────────┘     └─────────┘         │   │
│  │        │           │              │                  │              │   │
│  │        ▼           ▼              ▼                  ▼              │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────┐  ┌─────────────────┐      │   │
│  │  │ Sample  │  │ 50ms    │  │ 48kHz, mono │  │ Depacketized    │      │   │
│  │  │ Rate:   │  │ frames  │  │ 16-bit PCM  │  │ Opus frames     │      │   │
│  │  │ 48kHz   │  └─────────┘  └─────────────┘  └─────────────────┘      │   │
│  │  └─────────┘                                                        │   │
│  │                         Agent B (Receiver)                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  Configuration:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Codec: Opus (preferred), G.711 (fallback)                          │   │
│  │ Bitrate: 24-64 kbps (adaptive)                                      │   │
│  │ Sample Rate: 48kHz (HD), 16kHz (efficiency)                         │   │
│  │ Packet Size: 20ms (standard), 50ms (robustness)                     │   │
│  │ Latency Target: < 100ms round-trip                                 │   │
│  │ Packet Loss Concealment: Yes                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
